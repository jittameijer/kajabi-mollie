// /pages/api/cancel-request.js
import crypto from "crypto";

export const config = { api: { bodyParser: true } };

// Allowed origins (include www and non-www if applicable)
const ORIGINS = [
  "https://www.fortnegenacademy.nl",
  "https://fortnegenacademy.nl"
];

function setCors(req, res) {
  const origin = req.headers.origin;
  if (ORIGINS.includes(origin)) {
    res.setHeader("Access-Control-Allow-Origin", origin);
  }
  res.setHeader("Vary", "Origin");
  res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");
  res.setHeader("Access-Control-Max-Age", "86400");
}

function ok(res, data = {}) {
  // Always include CORS on exit
  res.status(200).json({ ok: true, ...data });
}

export default async function handler(req, res) {
  // üîê CORS first (preflight)
  setCors(req, res);
  if (req.method === "OPTIONS") return res.status(200).end();

  if (req.method !== "POST") {
    // still with CORS headers
    return res.status(405).json({ error: "Method Not Allowed" });
  }

  try {
    const body = typeof req.body === "string" ? JSON.parse(req.body || "{}") : (req.body || {});
    const email = (body.email || "").toLowerCase().trim();

    // Always respond 200 to avoid leaking whether an email exists
    if (!email) return ok(res);

    // üîé Lookup mapping in Upstash (adjust to your setup)
    const { Redis } = await import("@upstash/redis");
    const redis = new Redis({
      url: process.env.UPSTASH_REDIS_REST_URL,
      token: process.env.UPSTASH_REDIS_REST_TOKEN,
    });
    const key = `kajabi:email:${email}`;
    const ids = await redis.hgetall(key); // { mollieCustomerId, mollieSubscriptionId }

    // If no mapping, still return ok to user
    if (!ids?.mollieCustomerId || !ids?.mollieSubscriptionId) return ok(res);

    // Build signed token (30 min)
    const exp = Math.floor(Date.now()/1000) + 30 * 60;
    const secret = process.env.CANCEL_LINK_SECRET || "dev-secret";
    const payload = Buffer.from(JSON.stringify({
      email, customerId: ids.mollieCustomerId, subscriptionId: ids.mollieSubscriptionId, key, exp
    })).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
    const sig = crypto.createHmac("sha256", secret).update(payload).digest("base64")
      .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
    const token = `${payload}.${sig}`;

    const base = process.env.PUBLIC_BASE_URL || "https://kajabi-mollie.vercel.app";
    const link = `${base}/api/cancel-complete?token=${encodeURIComponent(token)}`;

    // ‚úâÔ∏è Send email (Resend optional)
    const RESEND_API_KEY = process.env.RESEND_API_KEY;
    const FROM = process.env.MAIL_FROM || "no-reply@fortnegenacademy.nl";
    const html = `
      <div style="font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif">
        <h2>Bevestig je opzegging</h2>
        <p>Klik op de knop om je abonnement stop te zetten. De link vervalt binnen 30 minuten.</p>
        <p><a href="${link}" style="display:inline-block;background:#97c8a8;color:#fff;padding:10px 14px;border-radius:8px;text-decoration:none;">Abonnement opzeggen</a></p>
        <p style="font-size:12px;color:#6b7280">Fort Negen Academy</p>
      </div>
    `;

    if (RESEND_API_KEY) {
      await fetch("https://api.resend.com/emails", {
        method: "POST",
        headers: { "Authorization": `Bearer ${RESEND_API_KEY}`, "Content-Type": "application/json" },
        body: JSON.stringify({ from: FROM, to: email, subject: "Bevestig je opzegging ‚Äì Fort Negen Academy", html })
      });
    } else {
      console.log("[DEV] Would send cancel email to:", email, "link:", link);
    }

    return ok(res);
  } catch (e) {
    console.error("cancel-request error:", e);
    // still return ok to keep UX consistent and not leak existence
    return ok(res);
  }
}
